{% extends 'account/base.html' %}
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> UVA Events </title>
    {% load static %}
    {% load socialaccount %}
    {% get_providers as socialaccount_providers %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body style="overflow: hidden">
    {% block body %}

    <!-- Alert block -->
    {% if messages %}
    <div class="alert alert-primary" role="alert">
        {% for message in messages %}
        <div class="text-center border-bottom">{{message}}</div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Navigation bar block -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">
                <img src="{% static 'img/uva_logo.png' %}" alt="" width="30" class="d-inline-block align-text-top">
                UVA Events
            </a>
            <ul class="navbar-nav">
                <li class="nav-item mx-3">
                    <a class="nav-link" href="{% url 'home' %}">Home</a>
                </li>
                {% if user.is_authenticated %}
                {% if user.is_staff %}
                <li class="nav-item mx-3">
                    <a class="nav-link" href="{% url 'admin_dash' %}">Admin Dashboard</a>
                </li>
                <li class="nav-item mx-3">
                    <a class="nav-link" href="{% url 'create_event' %}">Create Event</a>
                </li>
                {% else %}
                <li class="nav-item mx-3">
                    <a class="nav-link" href="{% url 'user_dash' %}">User Dashboard</a>
                </li>
                {% endif %}
                <li class="nav-item mx-3">
                    <a class="nav-link" href="{% url 'all_events' %}">All Events</a>
                </li>
                <li class="nav-item ms-3">
                    <a class="btn btn-outline-light rounded-pill px-4" href="{% url 'account_logout' %}">Sign Out</a>
                </li>
                {% else %}
                <li class="nav-item ms-3">
                    {% for provider in socialaccount_providers %}
                    <a title="{{provider.name}}" class="btn btn-outline-light rounded-pill px-4"
                        href="{% provider_login_url provider.id process=process scope=scope auth_params=auth_params action='reauthenticate' %}">
                        Login with
                        <img src="https://assets.stickpng.com/images/580b57fcd9996e24bc43c51f.png"
                            alt="{{ provider.name }}" height="20" />
                    </a>
                    {% endfor %}
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    {% block content %}

    <!-- Actual page content -->
    <div class="main-container">
        <div class="events-container">
            <h4 class="events-container-title">
                What's Happening?
            </h4>
            {%for event in event_list%}
            <div class="event-box">
                <div class="event-info">
                    <h2 class="event-title"> {{event.name}} </h2>
                    <span> {{event.address}} </span>
                </div>
                <a class="event-view-button btn btn-outline-light rounded-pill px-4" href = "{% url 'event' event.id %}">View</a>
            </div>
            {%endfor%}

        </div>
        <div class="map-container" style="width: 55%;">
            <div id="map"></div>
            <script>
                const eventCoordinates = JSON.parse('{{ event_coordinates|safe}}');
                const eventNames = JSON.parse('{{ event_names|safe }}');
                const eventUrls = {{ event_urls| safe }};
                recentCoord = eventCoordinates[eventCoordinates.length - 1] //getting the most recently added event
                recent_latlong = Object.values(recentCoord)
                recent_lati = parseFloat(recent_latlong[0])
                recent_long = parseFloat(recent_latlong[1])
                console.log(recent_lati, recent_long)

                function initMap() {
                    var center = { lat: recent_lati, lng: recent_long };
                    // {lat: 38.0336, lng: -78.5080}; // Coordinates for UVA, Charlottesville
                    var map_style = [
                        { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                        { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                        {
                            featureType: "administrative.locality",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#d59563" }],
                        },
                        {
                            featureType: "poi",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#d59563" }],
                        },
                        {
                            featureType: "poi.park",
                            elementType: "geometry",
                            stylers: [{ color: "#263c3f" }],
                        },
                        {
                            featureType: "poi.park",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#6b9a76" }],
                        },
                        {
                            featureType: "road",
                            elementType: "geometry",
                            stylers: [{ color: "#38414e" }],
                        },
                        {
                            featureType: "road",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#212a37" }],
                        },
                        {
                            featureType: "road",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#9ca5b3" }],
                        },
                        {
                            featureType: "road.highway",
                            elementType: "geometry",
                            stylers: [{ color: "#805e52" }],
                        },
                        {
                            featureType: "road.highway",
                            elementType: "geometry.stroke",
                            stylers: [{ color: "#1f2835" }],
                        },
                        {
                            featureType: "road.highway",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#f3d19c" }],
                        },
                        {
                            featureType: "transit",
                            elementType: "geometry",
                            stylers: [{ color: "#2f3948" }],
                        },
                        {
                            featureType: "transit.station",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#d59563" }],
                        },
                        {
                            featureType: "water",
                            elementType: "geometry",
                            stylers: [{ color: "#17263c" }],
                        },
                        {
                            featureType: "water",
                            elementType: "labels.text.fill",
                            stylers: [{ color: "#515c6d" }],
                        },
                        {
                            featureType: "water",
                            elementType: "labels.text.stroke",
                            stylers: [{ color: "#17263c" }],
                        },
                    ];

                    var options = {
                        zoom: 15,
                        center: center,
                        disableDefaultUI: true,
                        // mapTypeControl: true,
                        scaleControl: true,
                        zoomControl: true,
                        styles: map_style,
                    }
                    var map = new google.maps.Map(document.getElementById('map'), options);

                    // Add markers for each event's address

                    let currentInfoWindow = null;

                    for (let i = 0; i < eventCoordinates.length; i++) {
                        let eventCoord = eventCoordinates[i];
                        let eventN = eventNames[i].name;
                        let eventUrl = eventUrls[i];
                        let lati = parseFloat(eventCoord.lat);
                        let long = parseFloat(eventCoord.lng);

                        let marker = new google.maps.Marker({
                            position: { lat: lati, lng: long },
                            map: map
                        });

                        let infoWindow = new google.maps.InfoWindow({
                            content: '<strong>' + eventN + '</strong><br><a href="' + eventUrl + '">Click here to view event details</a>'
                        });

                        // Add a click event listener to the marker to open the InfoWindow
                        marker.addListener('click', function () {
                            if(currentInfoWindow){
                                currentInfoWindow.close();
                            }
                            infoWindow.open(map, marker);
                            currentInfoWindow = infoWindow;
                            map.setCenter(marker.getPosition());
                        });
                    }

                }
            </script>
            <script
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACbnTlCUWNwZd33XSLulbyx8WUfJBOvxQ&callback=initMap"
                async defer>
            </script>
        </div>
    </div>
    </div>

    {% endblock %}

    {% endblock %}

    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script> -->
</body>

</html>

<!-- 
    {% if curr_events %}
                    <h4 class="text-center">Ongoing Events</h4>
                    <div class="row">
                        {% for event in curr_events %}
                        <div class="col-sm-6 my-4">
                            <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{ event.name }}</h5>
                                <p class="card-text">{{ event.description }}</p>
                                <a href="{% url 'event' event.id %}" class="btn btn-dark rounded-pill px-4">View details</a>
                            </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if upcoming_events %}
                    <h4 class="text-center">Upcoming Events</h4>
                    <div class="row">
                        {% for event in upcoming_events %}
                        <div class="col-sm-6 my-4">
                            <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">{{ event.name }}</h5>
                                <p class="card-text">{{ event.description }}</p>
                                <a href="{% url 'event' event.id %}" class="btn btn-dark rounded-pill px-4">View details</a>
                            </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
 -->